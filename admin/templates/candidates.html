{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Кандидаты теста: {{ test.title }}</h1>
            <div>
                <a href="{{ url_for('edit_test', test_id=test.test_id) }}" class="btn btn-secondary">← Назад к тесту</a>
                <a href="{{ url_for('create_candidate', test_id=test.test_id) }}" class="btn btn-primary">Добавить кандидата</a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Список кандидатов</h5>
            </div>
            <div class="card-body">
                {% if candidates_stats %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ФИО</th>
                                <th>Должность</th>
                                <th>Отдел</th>
                                <th>Коды</th>
                                <th>Прогресс</th>
                                <th>Лучший результат</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidate in candidates_stats %}
                            <tr>
                                <td>
                                    <strong>{{ candidate.full_name }}</strong>
                                </td>
                                <td>{{ candidate.position or '-' }}</td>
                                <td>{{ candidate.department or '-' }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ candidate.used_codes }}/{{ candidate.total_codes }}</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        {% if candidate.total_codes > 0 %}
                                        <div class="progress-bar {% if candidate.used_codes == candidate.total_codes %}bg-success{% else %}bg-warning{% endif %}" 
                                             style="width: {{ (candidate.used_codes / candidate.total_codes * 100) }}%">
                                            {{ candidate.used_codes }}/{{ candidate.total_codes }}
                                        </div>
                                        {% else %}
                                        <div class="progress-bar bg-secondary" style="width: 100%">Нет кодов</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if candidate.tests_taken > 0 %}
                                    <span class="badge {% if candidate.best_score >= 80 %}bg-success{% elif candidate.best_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ candidate.best_score }}%
                                    </span>
                                    <small class="text-muted">({{ candidate.tests_taken }} попыток)</small>
                                    {% else %}
                                    <span class="badge bg-secondary">Нет результатов</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('candidate_codes', candidate_id=candidate.candidate_id) }}" class="btn btn-sm btn-primary">Коды</a>
                                    <a href="{{ url_for('edit_candidate', candidate_id=candidate.candidate_id) }}" class="btn btn-sm btn-outline-secondary">Редактировать</a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCandidate({{ candidate.candidate_id }}, '{{ candidate.full_name }}')">Удалить</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    Кандидатов пока нет. <a href="{{ url_for('create_candidate', test_id=test.test_id) }}">Добавьте первого кандидата</a>.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function deleteCandidate(candidateId, fullName) {
    if (confirm(`Вы уверены, что хотите удалить кандидата "${fullName}"? Все связанные коды также будут удалены.`)) {
        fetch(`/candidates/${candidateId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Ошибка: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ошибка: ' + error);
        });
    }
}
</script>
{% endblock %}