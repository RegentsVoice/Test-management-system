{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–í—Å–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã</h1>
    <div>
        <a href="{{ url_for('tests') }}" class="btn btn-secondary">‚Üê –ö —Ç–µ—Å—Ç–∞–º</a>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
            + –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏</h5>
    </div>
    <div class="card-body">
        {% if candidates %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>–§–ò–û</th>
                        <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                        <th>–û—Ç–¥–µ–ª</th>
                        <th>–¢–µ—Å—Ç</th>
                        <th>–ö–æ–¥—ã</th>
                        <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for candidate in candidates %}
                    <tr>
                        <td>
                            <strong>{{ candidate.full_name }}</strong>
                            {% if candidate.position or candidate.department %}
                            <br>
                            <small class="text-muted">
                                {% if candidate.position %}{{ candidate.position }}{% endif %}
                                {% if candidate.department %} ‚Ä¢ {{ candidate.department }}{% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td>{{ candidate.position or '-' }}</td>
                        <td>{{ candidate.department or '-' }}</td>
                        <td>
                            <span class="badge bg-info">{{ candidate.test_title }}</span>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ candidate.used_codes }}/{{ candidate.total_codes }}</span>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px; width: 120px;">
                                {% if candidate.total_codes > 0 %}
                                <div class="progress-bar {% if candidate.used_codes == candidate.total_codes %}bg-success{% else %}bg-warning{% endif %}" 
                                     style="width: {{ (candidate.used_codes / candidate.total_codes * 100) }}%">
                                    {{ candidate.used_codes }}/{{ candidate.total_codes }}
                                </div>
                                {% else %}
                                <div class="progress-bar bg-secondary" style="width: 100%">–ù–µ—Ç –∫–æ–¥–æ–≤</div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if candidate.tests_taken > 0 %}
                            <span class="badge {% if candidate.best_score >= 80 %}bg-success{% elif candidate.best_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ candidate.best_score }}%
                            </span>
                            <br>
                            <small class="text-muted">{{ candidate.tests_taken }} –ø–æ–ø—ã—Ç.</small>
                            {% else %}
                            <span class="badge bg-secondary">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('candidate_codes', candidate_id=candidate.candidate_id) }}" 
                                   class="btn btn-sm btn-primary" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞–º–∏">
                                    üìã –ö–æ–¥—ã
                                </a>
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="editCandidate({{ candidate.candidate_id }}, '{{ candidate.full_name }}', '{{ candidate.position or '' }}', '{{ candidate.department or '' }}', {{ candidate.test_id }})"
                                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteCandidate({{ candidate.candidate_id }}, '{{ candidate.full_name }}')"
                                        title="–£–¥–∞–ª–∏—Ç—å">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ candidates|length }}</h5>
                        <p class="card-text">–í—Å–µ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ candidates|selectattr('tests_taken', 'gt', 0)|list|length }}</h5>
                        <p class="card-text">–ü—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            {% set with_codes = candidates|selectattr('total_codes', 'gt', 0)|list|length %}
                            {{ with_codes }}
                        </h5>
                        <p class="card-text">–° –∫–æ–¥–∞–º–∏</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            {% set total_tests = candidates|sum(attribute='tests_taken') %}
                            {{ total_tests }}
                        </h5>
                        <p class="card-text">–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫</p>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <h5>–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</p>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
                + –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
<div class="modal fade" id="addCandidateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCandidateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="candidate_full_name" class="form-label">–§–ò–û –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ *</label>
                        <input type="text" class="form-control" id="candidate_full_name" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="candidate_position" class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                        <input type="text" class="form-control" id="candidate_position" name="position">
                    </div>
                    <div class="mb-3">
                        <label for="candidate_department" class="form-label">–û—Ç–¥–µ–ª/–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="candidate_department" name="department">
                    </div>
                    <div class="mb-3">
                        <label for="candidate_test_id" class="form-label">–¢–µ—Å—Ç *</label>
                        <select class="form-control" id="candidate_test_id" name="test_id" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</option>
                            <!-- –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
<div class="modal fade" id="editCandidateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCandidateForm">
                <input type="hidden" id="edit_candidate_id" name="candidate_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_full_name" class="form-label">–§–ò–û –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ *</label>
                        <input type="text" class="form-control" id="edit_full_name" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_position" class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                        <input type="text" class="form-control" id="edit_position" name="position">
                    </div>
                    <div class="mb-3">
                        <label for="edit_department" class="form-label">–û—Ç–¥–µ–ª/–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="edit_department" name="department">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–µ—Å—Ç</label>
                        <input type="text" class="form-control" id="edit_test_title" disabled>
                        <small class="text-muted">–¢–µ—Å—Ç –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('addCandidateModal').addEventListener('show.bs.modal', function() {
    fetch('/api/tests')
        .then(response => response.json())
        .then(tests => {
            const select = document.getElementById('candidate_test_id');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</option>';
            tests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.test_id;
                option.textContent = test.title;
                select.appendChild(option);
            });
        });
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
document.getElementById('addCandidateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/api/candidates', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ö–∞–Ω–¥–∏–¥–∞—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
    });
});

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
document.getElementById('editCandidateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const candidateId = document.getElementById('edit_candidate_id').value;
    
    fetch(`/api/candidates/${candidateId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ö–∞–Ω–¥–∏–¥–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
    });
});

function editCandidate(candidateId, fullName, position, department, testId) {
    document.getElementById('edit_candidate_id').value = candidateId;
    document.getElementById('edit_full_name').value = fullName;
    document.getElementById('edit_position').value = position || '';
    document.getElementById('edit_department').value = department || '';
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞
    fetch('/api/tests')
        .then(response => response.json())
        .then(tests => {
            const test = tests.find(t => t.test_id == testId);
            if (test) {
                document.getElementById('edit_test_title').value = test.title;
            }
        });
    
    new bootstrap.Modal(document.getElementById('editCandidateModal')).show();
}

function deleteCandidate(candidateId, fullName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ "${fullName}"? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) {
        fetch(`/api/candidates/${candidateId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ö–∞–Ω–¥–∏–¥–∞—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞: ' + error);
        });
    }
}
</script>
{% endblock %}