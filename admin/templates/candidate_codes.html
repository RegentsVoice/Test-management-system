{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>–ö–æ–¥—ã –¥–ª—è: {{ candidate.full_name }}</h1>
            <div>
                <a href="{{ url_for('test_candidates', test_id=test.test_id) }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º</a>
                <a href="{{ url_for('edit_candidate', candidate_id=candidate.candidate_id) }}" class="btn btn-outline-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th>–§–ò–û:</th>
                                <td><strong>{{ candidate.full_name }}</strong></td>
                            </tr>
                            <tr>
                                <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</th>
                                <td>{{ candidate.position or '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</td>
                            </tr>
                            <tr>
                                <th>–û—Ç–¥–µ–ª:</th>
                                <td>{{ candidate.department or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                            </tr>
                            <tr>
                                <th>–¢–µ—Å—Ç:</th>
                                <td>{{ test.title }}</td>
                            </tr>
                            <tr>
                                <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</th>
                                <td>{{ candidate.created_at[:16] }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
                    </div>
                    <div class="card-body">
                        {% if candidate_results and candidate_results.results %}
                        <div class="text-center">
                            {% set best_result = candidate_results.results[0] %}
                            {% set best_score = (best_result[4] / best_result[5] * 100)|round|int %}
                            <h3 class="text-{% if best_score >= 80 %}success{% elif best_score >= 60 %}warning{% else %}danger{% endif %}">
                                {{ best_score }}%
                            </h3>
                            <p class="mb-1">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                            <small class="text-muted">–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: {{ candidate_results.results|length }}</small>
                        </div>
                        {% else %}
                        <div class="text-center">
                            <h3 class="text-muted">-</h3>
                            <p class="mb-1">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>
                            <small class="text-muted">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –µ—â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª —Ç–µ—Å—Ç</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–æ–≤ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤</h5>
            </div>
            <div class="card-body">
                <form id="generateCodesForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="count" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤:</label>
                            <input type="number" class="form-control" id="count" name="count" min="1" max="10" value="1" required>
                        </div>
                        <div class="col-md-4">
                            <label for="purpose" class="form-label">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                            <select class="form-control" id="purpose" name="purpose">
                                <option value="–û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">–û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                                <option value="–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                                <option value="–û–±—É—á–µ–Ω–∏–µ">–û–±—É—á–µ–Ω–∏–µ</option>
                                <option value="–ü—Ä–æ–±–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">–ü—Ä–æ–±–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-key"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥—ã
                            </button>
                        </div>
                    </div>
                    <small class="text-muted">
                        üí° –ú–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–¥–æ–≤ –µ—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø–µ—Ä–µ—Å–¥–∞—á–∞, –æ–±—É—á–µ–Ω–∏–µ –∏ —Ç.–¥.)
                    </small>
                </form>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h5>
                <div>
                    <span class="badge bg-primary">–í—Å–µ–≥–æ: {{ codes|length }}</span>
                    <span class="badge bg-success">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{ codes|selectattr('is_used')|list|length }}</span>
                    <span class="badge bg-secondary">–ê–∫—Ç–∏–≤–Ω–æ: {{ codes|rejectattr('is_used')|list|length }}</span>
                </div>
            </div>
            <div class="card-body">
                {% if codes %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ö–æ–¥</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                                <th>–ö–µ–º —Å–æ–∑–¥–∞–Ω</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for code in codes %}
                            <tr>
                                <td>
                                    <code class="fs-5 fw-bold">{{ code.code }}</code>
                                    {% if not code.is_used %}
                                    <span class="badge bg-info ms-1">–ù–æ–≤—ã–π</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if code.is_used %}
                                    <span class="badge bg-success">‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</span>
                                    {% else %}
                                    <span class="badge bg-secondary">‚è≥ –ê–∫—Ç–∏–≤–µ–Ω</span>
                                    {% endif %}
                                </td>
                                <td>{{ code.created_at[:16] }}</td>
                                <td>
                                    {% set creator = namespace(username='–°–∏—Å—Ç–µ–º–∞') %}
                                    {% for admin in admins %}
                                        {% if admin.user_id == code.created_by %}
                                            {% set creator.username = admin.username %}
                                        {% endif %}
                                    {% endfor %}
                                    {{ creator.username }}
                                </td>
                                <td>
                                    {% if not code.is_used %}
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyCode('{{ code.code }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥">
                                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="shareCode('{{ code.code }}', '{{ candidate.full_name }}', '{{ test.title }}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                                        üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                    </button>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–¥–æ–≤ -->
                <div class="mt-3">
                    <button class="btn btn-outline-success btn-sm" onclick="exportCodes()">
                        üìÑ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–¥—ã –≤ CSV
                    </button>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <h5>–ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
                    <p>–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–µ—Ä–≤—ã–µ –∫–æ–¥—ã –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤—ã—à–µ</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        {% if candidate_results and candidate_results.results %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ë–∞–ª–ª—ã</th>
                                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in candidate_results.results %}
                            <tr>
                                <td>{{ result[6][:16] }}</td>
                                <td>
                                    {% set score_percent = (result[4] / result[5] * 100)|round|int %}
                                    <span class="badge {% if score_percent >= 80 %}bg-success{% elif score_percent >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ score_percent }}%
                                    </span>
                                </td>
                                <td>{{ result[4] }}/{{ result[5] }}</td>
                                <td><code>{{ result[3] }}</code></td>
                                <td>
                                    {% if result[8] %}
                                    {{ result[8] }} ({{ result[7] }})
                                    {% else %}
                                    {{ result[7] }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.getElementById('generateCodesForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const count = document.getElementById('count').value;
    const purpose = document.getElementById('purpose').value;
    const formData = new FormData();
    formData.append('count', count);
    formData.append('purpose', purpose);
    
    fetch('{{ url_for("generate_candidate_codes", candidate_id=candidate.candidate_id) }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${data.count} –∫–æ–¥–æ–≤ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞!\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥—ã –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.`);
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–æ–≤: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
    });
});

function copyCode(code) {
    navigator.clipboard.writeText(code).then(function() {
        alert('‚úÖ –ö–æ–¥ ' + code + ' —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n–ü–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.');
    }, function(err) {
        alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err);
    });
}

function shareCode(code, fullName, testTitle) {
    const message = `üîê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${fullName}\n–¢–µ—Å—Ç: ${testTitle}\n–ö–æ–¥: ${code}\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –±–æ—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.`;
    
    if (navigator.share) {
        navigator.share({
            title: '–ö–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
            text: message
        });
    } else {
        navigator.clipboard.writeText(message).then(function() {
            alert('‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–¥–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É!');
        });
    }
}

function exportCodes() {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "–ö–æ–¥,–°—Ç–∞—Ç—É—Å,–°–æ–∑–¥–∞–Ω,–°–æ—Ç—Ä—É–¥–Ω–∏–∫,–î–æ–ª–∂–Ω–æ—Å—Ç—å,–û—Ç–¥–µ–ª,–¢–µ—Å—Ç\n";
    
    {% for code in codes %}
    csvContent += "{{ code.code }},{% if code.is_used %}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω{% else %}–ê–∫—Ç–∏–≤–µ–Ω{% endif %},{{ code.created_at[:16] }},{{ candidate.full_name }},{{ candidate.position or '' }},{{ candidate.department or '' }},{{ test.title }}\n";
    {% endfor %}
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "–∫–æ–¥—ã_{{ candidate.full_name }}.csv");
    document.body.appendChild(link);
    link.click();
}
</script>
{% endblock %}